---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
---

<BaseLayout title={`${project.data.title} - Samar Ahsan`} description={project.data.description}>
  <article class="project-page">
    <header>
      <a href="/projects" class="back-link">&larr; All Projects</a>
      <h1>{project.data.title}</h1>
      {project.data.description && (
        <p class="description">{project.data.description}</p>
      )}
    </header>

    {(project.data.role || project.data.date || project.data.tools) && (
      <div class="meta">
        {project.data.role && (
          <div class="meta-item">
            <span class="meta-label">Role</span>
            <span class="meta-value">{project.data.role}</span>
          </div>
        )}
        {project.data.date && (
          <div class="meta-item">
            <span class="meta-label">Date</span>
            <span class="meta-value">{project.data.date}</span>
          </div>
        )}
        {project.data.team && project.data.team.length > 0 && (
          <div class="meta-item">
            <span class="meta-label">Team</span>
            <span class="meta-value">{project.data.team.join(', ')}</span>
          </div>
        )}
        {project.data.tools && project.data.tools.length > 0 && (
          <div class="meta-item">
            <span class="meta-label">Tools</span>
            <span class="meta-value">{project.data.tools.join(', ')}</span>
          </div>
        )}
      </div>
    )}

    {project.data.links && project.data.links.length > 0 && (
      <div class="links">
        {project.data.links.map((link) => (
          <a href={link.url} target="_blank" rel="noopener noreferrer" class="external-link">
            {link.label} &#8599;
          </a>
        ))}
      </div>
    )}

    {project.data.cover && !project.data.hideCoverOnPage && (
      <figure class="cover">
        <img src={project.data.cover} alt={project.data.title} />
      </figure>
    )}

    <div class="content">
      <Content />
    </div>

    {project.data.gallery && project.data.gallery.length > 0 && (
      <section class="gallery">
        {project.data.gallery.map((image) => (
          <figure>
            <img src={image} alt="" />
          </figure>
        ))}
      </section>
    )}
  </article>

  <!-- Lightbox Modal -->
  <div class="lightbox-modal" id="lightbox" aria-hidden="true" role="dialog" aria-modal="true">
    <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    <button class="lightbox-prev" aria-label="Previous image">&larr;</button>
    <button class="lightbox-next" aria-label="Next image">&rarr;</button>
    <img class="lightbox-image" src="" alt="" />
  </div>
</BaseLayout>

<style>
  /* Lightbox Modal */
  .lightbox-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .lightbox-modal.is-open {
    display: flex;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 4px;
  }

  .lightbox-close,
  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 1rem;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .lightbox-close:hover,
  .lightbox-prev:hover,
  .lightbox-next:hover {
    opacity: 1;
  }

  .lightbox-close {
    top: 1rem;
    right: 1rem;
    font-size: 2.5rem;
  }

  .lightbox-prev {
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
  }

  .lightbox-next {
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
  }

  @media (max-width: 768px) {
    .lightbox-prev,
    .lightbox-next {
      top: auto;
      bottom: 1rem;
      transform: none;
    }

    .lightbox-prev {
      left: 2rem;
    }

    .lightbox-next {
      right: 2rem;
    }
  }
  .project-page {
    max-width: var(--content-width);
  }

  header {
    margin-bottom: var(--space-8);
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-6);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--ink-muted);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    padding-bottom: 2px;
    transition: color 0.15s, border-color 0.15s;
  }

  .back-link:hover {
    color: var(--ink);
    border-color: var(--ink);
  }

  h1 {
    margin: 0 0 var(--space-3);
    font-family: var(--font-serif);
    font-size: var(--text-3xl);
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .description {
    font-family: var(--font-serif);
    font-size: var(--text-xl);
    color: var(--ink-muted);
    margin: 0;
    line-height: var(--leading-snug);
  }

  .meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-8);
    padding: var(--space-5) 0;
    border-top: 1px solid var(--rule);
    border-bottom: 1px solid var(--rule);
    margin-bottom: var(--space-8);
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .meta-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--ink-faint);
  }

  .meta-value {
    font-size: var(--text-sm);
    color: var(--ink);
  }

  .links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    margin-bottom: var(--space-8);
  }

  .external-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--ink);
    color: var(--bg);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    letter-spacing: 0.03em;
    text-transform: uppercase;
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: opacity 0.15s;
  }

  .external-link:hover {
    opacity: 0.85;
  }

  .cover {
    margin: 0 0 var(--space-10);
  }

  .cover img {
    width: 100%;
    border-radius: var(--radius-lg);
    border: 1px solid var(--rule);
  }

  .content {
    line-height: var(--leading-relaxed);
    font-size: var(--text-md);
  }

  .content :global(h2) {
    margin-top: var(--space-10);
    font-size: var(--text-2xl);
  }

  .content :global(h3) {
    margin-top: var(--space-8);
    font-size: var(--text-xl);
  }

  .content :global(img) {
    border-radius: var(--radius-lg);
    margin: var(--space-6) 0;
  }

  .gallery {
    margin-top: var(--space-12);
    display: grid;
    gap: var(--space-4);
  }

  .gallery figure {
    margin: 0;
  }

  .gallery img {
    width: 100%;
    border-radius: var(--radius-lg);
  }

  /* Editorial Collage Layout */
  .content :global(.collage) {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin: 2rem 0;
  }

  .content :global(.collage img) {
    width: 100%;
    height: auto;
    display: block;
  }

  .content :global(.collage-two) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.25rem;
  }

  .content :global(.collage-three) {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.25rem;
  }

  /* Collage scroll animations */
  .content :global(.collage img) {
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.6s ease, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .content :global(.collage img.is-visible) {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .content :global(.collage img) {
      opacity: 1;
      transform: none;
      transition: none;
    }
  }

  @media (max-width: 768px) {
    .content :global(.collage-two),
    .content :global(.collage-three) {
      grid-template-columns: 1fr;
    }
  }

  /* Blurb Block */
  .content :global(.blurb) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2.5rem;
  }

  .content :global(.blurb-item) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .content :global(.blurb-label) {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .content :global(.blurb-item p) {
    margin: 0;
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .content :global(.blurb.blurb-three) {
    grid-template-columns: repeat(3, 1fr);
  }

  @media (max-width: 768px) {
    .content :global(.blurb) {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }

  /* Caption Gallery */
  .content :global(.caption-gallery) {
    display: flex;
    flex-direction: column;
    gap: 3rem;
    margin: 2rem 0;
  }

  .content :global(.gallery-row) {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .content :global(.gallery-images) {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
  }

  .content :global(.gallery-images img) {
    width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 0;
  }

  .content :global(.gallery-captions) {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    align-items: start;
  }

  .content :global(.gallery-captions figcaption) {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    line-height: 1.4;
    margin: 0;
  }

  .content :global(.gallery-captions figcaption strong) {
    color: var(--color-text);
    display: block;
    margin-bottom: 0.25rem;
  }

  @media (max-width: 768px) {
    .content :global(.gallery-images),
    .content :global(.gallery-captions) {
      grid-template-columns: 1fr;
    }

    .content :global(.gallery-row) {
      gap: 1.5rem;
    }

    .content :global(.gallery-captions figcaption) {
      margin-bottom: 1rem;
    }
  }

  /* Square Gallery */
  .content :global(.square-gallery) {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin: 3rem 0;
  }

  .content :global(.square-gallery img) {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 4px;
    margin: 0;
  }

  @media (max-width: 768px) {
    .content :global(.square-gallery) {
      grid-template-columns: 1fr;
    }
  }

  /* TikTok Embed */
  .content :global(.tiktok-container) {
    display: flex;
    justify-content: center;
    margin: 2rem 0;
  }

  .content :global(.tiktok-embed) {
    margin: 0 !important;
  }

  /* Lightbox Gallery */
  .content :global(.lightbox-gallery) {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin: 2rem 0;
  }

  .content :global(.lightbox-gallery img) {
    width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 0;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .content :global(.lightbox-gallery img:hover) {
    opacity: 0.85;
  }

  @media (max-width: 768px) {
    .content :global(.lightbox-gallery) {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    h1 {
      font-size: var(--text-2xl);
    }

    .description {
      font-size: var(--text-lg);
    }

    .meta {
      gap: var(--space-6);
    }
  }
</style>

<script>
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (!prefersReducedMotion) {
    const collageImages = document.querySelectorAll('.collage img');

    const imageObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            imageObserver.unobserve(entry.target);
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      }
    );

    collageImages.forEach((img) => {
      imageObserver.observe(img);
    });
  } else {
    document.querySelectorAll('.collage img').forEach((img) => {
      img.classList.add('is-visible');
    });
  }

  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = lightbox?.querySelector('.lightbox-image');
  const lightboxClose = lightbox?.querySelector('.lightbox-close');
  const lightboxPrev = lightbox?.querySelector('.lightbox-prev');
  const lightboxNext = lightbox?.querySelector('.lightbox-next');
  const galleryImages = document.querySelectorAll('.lightbox-gallery img');

  let currentIndex = 0;
  let previouslyFocusedElement = null;

  function openLightbox(index) {
    if (!lightbox || !lightboxImage || galleryImages.length === 0) return;

    currentIndex = index;
    const img = galleryImages[currentIndex];
    lightboxImage.src = img.src;
    lightboxImage.alt = img.alt;

    previouslyFocusedElement = document.activeElement;
    lightbox.classList.add('is-open');
    lightbox.setAttribute('aria-hidden', 'false');
    lightboxClose?.focus();
  }

  function closeLightbox() {
    if (!lightbox) return;

    lightbox.classList.remove('is-open');
    lightbox.setAttribute('aria-hidden', 'true');
    previouslyFocusedElement?.focus();
  }

  function showPrev() {
    if (galleryImages.length === 0) return;
    currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
    const img = galleryImages[currentIndex];
    if (lightboxImage) {
      lightboxImage.src = img.src;
      lightboxImage.alt = img.alt;
    }
  }

  function showNext() {
    if (galleryImages.length === 0) return;
    currentIndex = (currentIndex + 1) % galleryImages.length;
    const img = galleryImages[currentIndex];
    if (lightboxImage) {
      lightboxImage.src = img.src;
      lightboxImage.alt = img.alt;
    }
  }

  galleryImages.forEach((img, index) => {
    img.addEventListener('click', () => openLightbox(index));
  });

  lightboxClose?.addEventListener('click', closeLightbox);
  lightboxPrev?.addEventListener('click', showPrev);
  lightboxNext?.addEventListener('click', showNext);

  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  document.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('is-open')) return;

    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'ArrowRight') showNext();
  });
</script>
